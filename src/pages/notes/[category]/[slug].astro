---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';

// 1. 生成静态路径
export async function getStaticPaths() {
  // 获取所有笔记
  const allNotes = await getCollection('notes');

  // 遍历所有笔记，解析 slug 生成路径参数
  // 假设 slug 格式为 "高等数学/傅里叶变换"
  return allNotes.map((entry) => {
    // 将 slug 按 "/" 切分
    const parts = entry.slug.split('/');
    
    // 如果文件在根目录（没有分类），需要做容错处理（这里假设一定有分类）
    const category = parts[0];
    const slug = parts.slice(1).join('/'); // 处理多级目录的情况

    return {
      params: { category, slug },
      props: { entry }, // 直接把笔记对象传给页面
    };
  });
}

// 2. 获取数据
const { category, slug } = Astro.params;
const { entry } = Astro.props;

// 3. 渲染内容 (这是 Astro 内置的，支持 MDX 组件！)
const { Content } = await entry.render();

// 提取标题：优先用 frontmatter 里的 title，没有就用文件名 (slug)
const title = entry.data.title || slug;
---

<BaseLayout title={title}>
  <article class="note-content">
    <Breadcrumb items={[
      { label: '笔记', href: '/notes' },
      { label: category!, href: `/notes/${category}` },
      { label: title, href: `/notes/${category}/${slug}` }
    ]} />
    
    <h1>{title}</h1>
    
    <div class="content-body">
      <Content />
    </div>
  </article>

  <style>
    h1 {
      font-size: 2.5rem;
      margin: 0 0 2rem 0;
    }

    .note-content {
      line-height: 1.8;
      font-size: 1rem;
    }

    .content-body {
      margin-top: 2rem;
    }

    :global(.content-body h1),
    :global(.content-body h2),
    :global(.content-body h3),
    :global(.content-body h4),
    :global(.content-body h5),
    :global(.content-body h6) {
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
      font-weight: 600;
    }

    :global(.content-body h2) {
      font-size: 1.5rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px solid var(--color-border);
    }

    :global(.content-body h3) {
      font-size: 1.2rem;
    }

    :global(.content-body p) {
      margin-bottom: 1rem;
      color: var(--color-text-primary);
    }

    :global(.content-body ul),
    :global(.content-body ol) {
      margin-left: 2rem;
      margin-bottom: 1rem;
    }

    :global(.content-body li) {
      margin-bottom: 0.5rem;
    }

    :global(.content-body a) {
      color: var(--color-primary);
      text-decoration: none;
    }

    :global(.content-body a:hover) {
      text-decoration: underline;
    }
  </style>
</BaseLayout>
